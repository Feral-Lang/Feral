#include "VM/VM.hpp"

namespace fer
{

FERAL_FUNC(enumNew, 1, true,
           " fn(values...) -> Enum\n"
           "Creates and returns an Enum using the given values")
{
    VarStruct *res = vm.makeVar<VarStruct>(loc, nullptr);
    res->reserveAttrs(args.size() + assnArgs->size() - 1);

    for(size_t i = 1; i < args.size(); ++i) {
        auto &a = args[i];
        EXPECT_AND(VarStr, a, "enums (use string / atom)", vm.decVarRef(res));
        res->setAttr(vm, as<VarStr>(a)->getVal(), vm.makeVar<VarInt>(loc, i - 1), true);
    }

    for(auto it = assnArgs->begin(); it != assnArgs->end(); assnArgs->next(it)) {
        EXPECT_AND(VarInt, it.val(), "enum field value", vm.decVarRef(res));
        Var *cp = vm.copyVar(loc, it.val());
        if(!cp) {
            vm.decVarRef(res);
            return nullptr;
        }
        res->setAttr(vm, it.key(), cp, false);
    }

    return res;
}

} // namespace fer