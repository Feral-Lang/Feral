#include <charconv>

#include "VM/Interpreter.hpp"

namespace fer
{

FERAL_FUNC(nilToInt, 0, false,
           "  var.fn() -> Int\n"
           "Returns `0` which is the int equivalent for nil.")
{
    return vm.makeVar<VarInt>(loc, 0);
}

FERAL_FUNC(boolToInt, 0, false,
           "  var.fn() -> Int\n"
           "Returns `1` if `var` is `true`, `0` otherwise.")
{
    return vm.makeVar<VarInt>(loc, as<VarBool>(args[0])->getVal() ? 1 : 0);
}

FERAL_FUNC(typeIDToInt, 0, false,
           "  var.fn() -> Int\n"
           "Returns the integer value of the given typeID `var`.")
{
    return vm.makeVar<VarInt>(loc, as<VarTypeID>(args[0])->getVal());
}

FERAL_FUNC(intToInt, 0, false,
           "  var.fn() -> var\n"
           "Returns `var` as is.")
{
    return args[0];
}

FERAL_FUNC(fltToInt, 0, false,
           "  var.fn() -> Int\n"
           "Converts the given float `var` to int and returns it.")
{
    return vm.makeVar<VarInt>(loc, as<VarFlt>(args[0])->getVal());
}

FERAL_FUNC(strToIntNative, 1, false, "")
{
    EXPECT(VarInt, args[1], "base");
    StringRef num = as<VarStr>(args[0])->getVal();
    for(auto c : num) {
        if(c == '-' || (c >= '0' && c <= '9')) continue;
        vm.fail(loc, "string '", num, "' is not a number");
        return nullptr;
    }
    int64_t base = as<VarInt>(args[1])->getVal();
    int64_t val;
    std::from_chars(num.data(), num.data() + num.size(), val, base);
    return vm.makeVar<VarInt>(loc, val);
}

} // namespace fer