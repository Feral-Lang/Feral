#include "VM/VM.hpp"

namespace fer
{

FERAL_FUNC(allToStr, 0, false,
           "  var.fn() -> Str\n"
           "Returns the type name and memory address of `var`.\n"
           "This function is used as a default if a type doesn't implement its own `.str()` member "
           "function.")
{
    VarStr *res = vm.makeVar<VarStr>(loc, "");
    res->getVal() += "Type: ";
    res->getVal() += vm.getTypeName(args[0]);
    res->getVal() += " at ";
    char tmp[24];
    snprintf(tmp, sizeof(tmp) / sizeof(tmp[0]), "%p", args[0]);
    res->getVal() += tmp;
    return res;
}

FERAL_FUNC(bytebufferToStr, 0, false,
           "  var.fn() -> Str\n"
           "Converts the bytes in the Bytebuffer `var` into a string and returns it.")
{
    VarBytebuffer *self = as<VarBytebuffer>(args[0]);
    if(self->capacity() == 0) return vm.makeVar<VarStr>(loc, "");
    return vm.makeVar<VarStr>(loc, self->getVal(), self->size());
}

FERAL_FUNC(nilToStr, 0, false,
           "  var.fn() -> Str\n"
           "Returns `'(nil)'`.")
{
    return vm.makeVar<VarStr>(loc, "(nil)");
}

FERAL_FUNC(boolToStr, 0, false,
           "  var.fn() -> Str\n"
           "Returns `'true'` if `var` is `true`, `'false'` otherwise.")
{
    return vm.makeVar<VarStr>(loc, as<VarBool>(args[0])->getVal() ? "true" : "false");
}

FERAL_FUNC(typeIDToStr, 0, false,
           "  var.fn() -> Str\n"
           "Returns the string representation of the typeID `var` with the ID as `number` as "
           "`'typeid<number>'`.")
{
    VarStr *res = vm.makeVar<VarStr>(loc, "typeid<");
    res->getVal() += std::to_string(as<VarTypeID>(args[0])->getVal());
    res->getVal() += ">";
    return res;
}

FERAL_FUNC(intToStr, 0, false,
           "  var.fn() -> Str\n"
           "Converts the int `var` into a string and returns it.")
{
    return vm.makeVar<VarStr>(loc, std::to_string(as<VarInt>(args[0])->getVal()));
}

FERAL_FUNC(fltToStr, 0, false,
           "  var.fn() -> Str\n"
           "Converts the float `var` into a string and returns it.")
{
    return vm.makeVar<VarStr>(loc, std::to_string(as<VarFlt>(args[0])->getVal()));
}

FERAL_FUNC(strToStr, 0, false,
           "  var.fn() -> var\n"
           "Returns `var` as is.")
{
    return args[0];
}

FERAL_FUNC(failureToStr, 0, false,
           "  var.fn() -> Str\n"
           "Returns the message in the failure `var`.")
{
    return vm.makeVar<VarStr>(loc, as<VarFailure>(args[0])->getMsg());
}

FERAL_FUNC(pathToStr, 0, false,
           "  var.fn() -> Str\n"
           "Converts the path `var` into a string and returns it.")
{
    return vm.makeVar<VarStr>(loc, as<VarPath>(args[0])->getStr());
}

FERAL_FUNC(structToStr, 0, false,
           "  var.fn() -> Str\n"
           "Returns a string representation of all the fields and their respective values in the "
           "struct `var`.\n"
           "Each of the fields' values have their `.str()` member function invoked to get their "
           "string representation.")
{
    VarStruct *st = as<VarStruct>(args[0]);
    VarStr *res   = vm.makeVar<VarStr>(loc, vm.getTypeName(st->getSubType()));
    res->getVal() += "{";
    for(auto it = st->attrBegin(); it != st->attrEnd(); st->attrNext(it)) {
        Var *v = nullptr;
        Array<Var *, 1> tmp{it.val()};
        if(!vm.callVarAndExpect<VarStr>(loc, "str", v, tmp, {})) {
            vm.decVarRef(res);
            return nullptr;
        }
        res->getVal() += it.key();
        res->getVal() += ": ";
        res->getVal() += as<VarStr>(v)->getVal();
        vm.decVarRef(v);
        res->getVal() += ", ";
    }
    if(st->getAttrCount() > 0) {
        res->getVal().pop_back();
        res->getVal().pop_back();
    }
    res->getVal() += "}";
    return res;
}

} // namespace fer

// TODO: vecToStr() must be done in feral code as Var::toStr() does not exist
// TODO: mapToStr() must be done in feral code as Var::toStr() does not exist