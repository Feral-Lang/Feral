#include "VM/Interpreter.hpp"

namespace fer
{

FERAL_FUNC(structNew, 0, false,
           "  fn(assnArgs...) -> Struct\n"
           "Creates a structure definition with fields defined by `assnArgs` and returns it.")
{
    MemoryManager &mem = vm.getMemoryManager();
    VarStructDef *res  = vm.makeVar<VarStructDef>(loc, assnArgs.size());
    for(auto &attr : assnArgs) {
        res->setAttr(mem, attr.first, attr.second.val, true);
        res->setAttrOrderAt(attr.second.pos, attr.first);
    }
    return res;
}

FERAL_FUNC(structDefSetTypeName, 1, false,
           "  var.fn(name) -> Nil\n"
           "Sets a `name` for the Struct definition `var` in the Feral virtual machine.\n"
           "This is used mainly to provide better error messages but its always best to set it for "
           "any Struct.")
{
    EXPECT(VarStr, args[1], "struct name");
    VarStructDef *def  = as<VarStructDef>(args[0]);
    const String &name = as<VarStr>(args[1])->getVal();
    vm.setTypeName(def->getID(), name);
    return vm.getNil();
}

FERAL_FUNC(structDefLen, 0, false,
           "  var.fn() -> Int\n"
           "Returns the number of fields in the Struct definition `var`.")
{
    VarStructDef *def = as<VarStructDef>(args[0]);
    return vm.makeVar<VarInt>(loc, def->getAttrCount());
}

FERAL_FUNC(structLen, 0, false,
           "  var.fn() -> Int\n"
           "Returns the number of fields in the Struct instance `var`.")
{
    VarStruct *st = as<VarStruct>(args[0]);
    return vm.makeVar<VarInt>(loc, st->getAttrCount());
}

} // namespace fer